---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
P <- read_csv("../data/MarriagePanel.csv")
M <- read_csv("../data/MarriageFile.csv")
K <- read_csv("../data/KidPanel.csv")

```


# Facts and Moments from the Data

## Child Development Moments

We separate children into three groups (never divorced, will divorce, and divorced) and calculate average test scores. We'll do this at each age, then also standardized, before creating age groups also.

```{r}
K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  group_by(dgroup,AGE) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  ggplot(aes(x=AGE,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (raw)")
```

```{r}
K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  group_by(AGE) %>%
  mutate(AP_raw = (AP_raw - mean(AP_raw))/sd(AP_raw)) %>%
  group_by(dgroup,AGE) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  ggplot(aes(x=AGE,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (standardized)")
```
```{r}
K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  ggplot(aes(x=age_group,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (raw)")
```

```{r}
K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  group_by(AGE) %>%
  mutate(AP_raw = (AP_raw - mean(AP_raw))/sd(AP_raw)) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  ggplot(aes(x=age_group,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (raw)")

```
## Comparison Using Separation instead of Divorce
```{r}
m1 <- K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  group_by(AGE) %>%
  mutate(AP_raw = (AP_raw - mean(AP_raw))/sd(AP_raw)) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  mutate(case="Using Divorce")

m2 <- K %>%
  select(AGE,AP_raw,sgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(sgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  group_by(AGE) %>%
  mutate(AP_raw = (AP_raw - mean(AP_raw))/sd(AP_raw)) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  mutate(case="Using Separation")


rbind(m1,m2) %>%
  ggplot(aes(x=age_group,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (standardized)") + facet_grid(. ~ case)

```

```{r}
m1 <- K %>%
  select(AGE,AP_raw,dgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(dgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  mutate(case="Using Divorce")

m2 <- K %>%
  select(AGE,AP_raw,sgroup) %>%
  drop_na() %>%
  mutate(dgroup = factor(sgroup,labels=c("Never Divorced","Will Divorce","Divorced"),levels=c(1,2,3))) %>%
  mutate(age_group = case_when(AGE<=5 ~ 1,AGE>=14 ~ 4,AGE>=10 ~ 3,AGE>=6 ~ 2)) %>%
  group_by(dgroup,age_group) %>%
  summarize(m = mean(AP_raw),se = sd(AP_raw)/n()) %>%
  mutate(case="Using Separation")


rbind(m1,m2) %>%
  ggplot(aes(x=age_group,y=m,ymin=m-1.96*se,ymax=m+1.96*se,color=dgroup)) + geom_line() + geom_point() + geom_errorbar(width=0.) + ggtitle("Average AP score by Marital Status (raw)") + facet_grid(. ~ case)
```


## Wife's Labor Supply

Here we look at changes in the wife's labor supply.

```{r}
P %>%
  select(M_hrs,TSD,M_AGE) %>%
  drop_na() %>%
  mutate(FT = M_hrs>1500) %>%
  # group_by(M_AGE) %>%
  # mutate(FT = FT - mean(FT)) %>%
  # ungroup() %>%
  filter(TSD>=-5,TSD<=10) %>%
  group_by(TSD) %>%
  summarize(sd = sqrt(var(FT)/n()),FT = mean(FT)) %>%
  ggplot(aes(x=TSD,y=FT,ymin=FT-1.96*sd,ymax=FT+1.96*sd)) + geom_line() + geom_point() + geom_errorbar(width=0.)
```

```{r}
P %>%
  select(M_hrs,TSD,M_AGE) %>%
  drop_na() %>%
  mutate(PT = M_hrs>0 & M_hrs<=1500) %>%
  # group_by(M_AGE) %>%
  # mutate(PT = PT - mean(PT)) %>%
  # ungroup() %>%
  filter(TSD>=-5,TSD<=10) %>%
  group_by(TSD) %>%
  summarize(sd = sqrt(var(PT)/n()),PT = mean(PT)) %>%
  ggplot(aes(x=TSD,y=PT,ymin=PT-1.96*sd,ymax=PT+1.96*sd)) + geom_line() + geom_point() + geom_errorbar(width=0.)

```


## Life-Cycle Moments

NOTE: we have some "outlier" observations, marriages that start when the woman is very young. we want to perhaps restrict our observations.


```{r}
lc_moms <- P %>%
  mutate(AGE_MAR = YMAR-YBIRTH_M) %>%
  filter(AGE_MAR>=18) %>%
  group_by(M_AGE) %>%
  filter(M_AGE>=18,M_AGE<=45) %>%
  summarize(Divorced = mean(DIV),Kids = mean(YBIRTH<=YEAR),FT = mean(M_hrs>1750,na.rm = TRUE),PT = mean(M_hrs>0 & M_hrs<1750,na.rm = TRUE),DivKids = mean(DIV & YBIRTH<=YEAR)) %>%
  pivot_longer(-M_AGE)

lc_moms %>%
  ggplot(aes(x=M_AGE,y=value)) + geom_point() + geom_line() + facet_wrap(. ~ name)

```

```{r}
lc_moms <- P %>%
  mutate(AGE_MAR = YMAR-YBIRTH_M) %>%
  filter(AGE_MAR>=18) %>%
  group_by(M_AGE,edW) %>%
  filter(M_AGE>=18,M_AGE<=45) %>%
  summarize(Divorced = mean(DIV),Kids = mean(YBIRTH<=YEAR),FT = mean(M_hrs>1750,na.rm = TRUE),PT = mean(M_hrs>0 & M_hrs<1750,na.rm = TRUE),DivKids = mean(DIV & YBIRTH<=YEAR)) %>%
  pivot_longer(-c("M_AGE","edW"))

lc_moms %>%
  ggplot(aes(x=M_AGE,y=value,color=as.factor(edW))) + geom_point() + geom_line() + facet_wrap(. ~ name)

```


